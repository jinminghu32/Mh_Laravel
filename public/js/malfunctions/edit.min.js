var chart=null,original_data=new Array,calculating=!1,NOTHINIG=0,LOAD_STATISTICS_CHART=0,REDIRECT_TO_FORMLIST_PAGE=1;function isImage(t=""){var a=(t=t.split("."))[t.length-1];return-1!==$.inArray(a.toLowerCase(),["jpg","jpeg","bmp","gif","png"])}function saveMalfunctionForm(t=NOTHINIG){if(calculating)console.log("do nothing");else{calculating=!0;var a=$("#malfunction-form").serialize();"ח"===$("#change-risk-select").find(":selected").text().trim()&&"severe"===$("#paragraph-type-hidden-input").val()&&$("#risk-value-span").text("גבוה"),$.ajax({url:UPDATE_URL,data:a,method:"POST",success:function(a){switch(t){case LOAD_STATISTICS_CHART:reloadStatistics(),calculating=!1;break;case REDIRECT_TO_FORMLIST_PAGE:location.href=FORM_LIST_URL}calculating=!1}})}}function uploadProgressHandler(t){var a=t.loaded/t.total*100,e=Math.round(a);$(".uploadProgressBar").css("width",e+"%")}function loadHandler(t){$(".uploadProgressBar").parent().remove()}function updateTime(t){$("input[name='data[time_]']").val($(t).val()),saveMalfunctionForm()}function uploadFiles(t){for(var a=$(this).prop("file").files,e=new FormData,n=!1,i=0;i<a.length;i++){var o=a[i];e.append("uploads[]",o,o.name)}$.ajax({url:UPLOAD_FILES_URL,dataType:"text",cache:!1,contentType:!1,processData:!1,data:e,type:"post",success:function(t){$.each(JSON.parse(t),function(t,a){n=isImage(a),$("#malfunction-uploaded-documents").prepend('<div class="malfunction-uploads__item">'+`<a href="${BASE_URL}/uploads/${a}" target="_blank" class="malfunction-uploads__text">`+(n?'<img class="malfunction-principal__photo-item" src="'+BASE_URL+"/uploads/"+a+'" alt="'+a+'"/>':a.length>20?a.substr(0,20):a)+"</a>"+`<i class="malfunction-uploads__item-remove"></i>\n                        <input type="hidden" name="data[malfunction-uploads][]" value="${a}"/>\n                     </div>`)}),saveMalfunctionForm()}})}function getTodayDate(){var t=new Date,a=t.getDate(),e=t.getMonth()+1;return a<10&&(a="0"+a),e<10&&(e="0"+e),a+"/"+e+"/"+t.getFullYear()}function currentTime(){$("#time").val()||($("#time").val(moment().format("HH:mm")),$("input[name='data[time_]']").val($("#time").val()))}function today(){var t=new Date,a=t.getDate(),e=t.getMonth()+1,n=t.getFullYear().toString().substr(-2);$("#datepicker").val()||($("#datepicker").val(a+"-"+e+"-"+n),$("input[name='data[date]']").val($("#datepicker").val()))}function reloadStatistics(){if("site"!=$("#site option:selected").val()){var t=$("#site option:selected").text(),a=$("#subsite option:selected").text();"subsite"==$("#subsite option:selected").val()&&(a="");var e=[];e.push({site:t,subsite:a});var n=$("#datepicker").val(),i=n.split("-");3==i.length&&(n=2e3+parseInt(i[2])+"-"+i[1]+"-"+i[0]);var o=new Date(n),l=new Date(n);o=new Date(o.setMonth(o.getMonth()-6));var s={_token:TOKEN,sites:e,start_date:getFormatDate(o),end_date:getFormatDate(l),statistic_type:"Total score"};$.ajax({url:GET_STATISTICS_URL,type:"get",dataType:"json",data:s,success:function(t){updateChart(t)}})}}function updateChart(t){if(null!=chart){for(var a=[],e=0,n=null,i=null,o=0;null!=t.data&&o<t.data.length;o++){for(var l=t.data[o],s=[],c=[],r=0;r<l.data.length;r++){var d=new Date(l.data[r].date);d.setHours(0),d.setMinutes(0),d.setSeconds(0),s.push({x:d,y:parseFloat(l.data[r].score),indexLabel:l.data[r].score,markerType:"retangle",markerColor:"#6B8E23"})}s.sort(function(t,a){return new Date(a.x)-new Date(t.x)});for(r=0;r<s.length;){c.push(s[r]),null==n&&null==i&&(n=new Date(s[r].x),i=new Date(s[r].x)),n-new Date(s[r].x)>0&&(n=new Date(s[r].x)),new Date(s[r].x-i)>0&&(i=new Date(s[r].x));var u=[];u.push(s[r].y);for(var p=r+1;p<s.length;p++)c[c.length-1].x-s[p].x==0&&u.push(s[p].y);var m=0;for(p=0;p<u.length;p++)m+=$.isNumeric(u[p])?u[p]:0;e<(m/=u.length)&&(e=m),c[c.length-1].y=m,c[c.length-1].indexLabel=m.toFixed(2).toString(),r+=u.length}a.push({type:"line",markerSize:12,lineThickness:4,xValueFormatString:"YYYY-MM-DD",yValueFormatString:"###.#",dataPoints:c,axisYType:"secondary"})}for(o=0;null!=chart.data&&o<chart.data.length;o++)chart.data[o].remove();if(null!=n&&null!=i){var f=new Date(n.getTime()+6048e5);chart.options.axisX.intervalType=f-i>=0?"day":"week"}chart.options.data=a,chart.options.axisY2.interval=e?e/6:void 0,chart.options.axisY2.labelFormatter=function(t){return t.value.toFixed(2)},chart.render(),clearTrialMark($(".canvasjs-chart-canvas")[0],"#fff",chart.height)}}function sendFile(){var t=$("#to_address").val(),a=$("#message_subject").val(),e=$("#message_body").val();if(e=e.replace(/(\n|\r)/g,"<br>"),""!=t&&""!=a&&""!=e){$(".modal.sharing").removeClass("show"),$("#app nav").css("display","none"),$(".malfunction-other").css("display","none");for(var n=$(document).width(),i=$(document).height(),o=1;o<=10;o++)if(i*o>n){i*=o;break}var l=null,s=null;html2pdf(document.documentElement,{margin:1,filename:"statistics_scoring"+(new Date).getTime()+".pdf",image:{type:"jpeg",quality:.98},html2canvas:{dpi:192,letterRendering:!0},jsPDF:{unit:"pt",format:[n,i],orientation:"portrait"},callback:function(o,c){l=o,$("#app nav").css("display","none"),$(".malfunction-scoring").css("display","none"),n=$(document).outerWidth(),i=$(document).outerHeight();for(var r=1;r<=10;r++)if(i*r>n){i*=r;break}html2pdf(document.documentElement,{margin:1,filename:"מבדק.pdf",image:{type:"jpeg",quality:.98},html2canvas:{dpi:192,letterRendering:!0},jsPDF:{unit:"pt",format:[n,i],orientation:"portrait"},callback:function(n,i){s=n;var o=new FormData;o.append("_token",TOKEN),o.append("other_pdf",s.output("blob")),o.append("scoring_pdf",l.output("blob")),o.append("to",t),o.append("subject",a),o.append("body",e),$.ajax({url:SEND_PDF_URL,method:"POST",data:o,processData:!1,contentType:!1}).done(function(t){showAlert("success",Lang["Message sent successfully"])}).fail(function(){showAlert("success",Lang["Email was not sent"])})}}),$(".malfunction-scoring").css("display","block"),$("#app nav").css("display","flex")}}),$(".malfunction-other").css("display","block"),$("#app nav").css("display","flex")}}function getOriginalHtml(t){var a="";return $.each(original_data,function(e,n){n.uuid==t&&(a=n.data)}),a}function updateOriginalData(){$.each($(".summernote-textarea").not(".disabled"),function(t,a){var e=$(a).attr("uuid");void 0!==e&&!1!==e||(e=Math.random().toString(36).substr(2,9),$(a).attr("uuid",e),original_data.push({uuid:e,data:$(a).summernote("code")}))})}function checkError(){var t="site"==$("#site").val();return t|=$("#subsite option").length>=2&&"subsite"==$("#subsite").val(),t|=-1==$("#service_level").val(),$.each($(".malfunction-scoring__item"),function(a,e){var n=$(e),i=n.find(".malfunction-type-select").val(),o=n.find(".malfunction-finding-select").val();t|=!i||("S"==i||"B"==i)&&!o.length}),t}function updateSendToAdminButton(){checkError()?$("#send_to_admin").addClass("disabled"):$("#send_to_admin").removeClass("disabled")}function updateScoreLevels(){checkError()&&($("#calc-input-total").val(""),$(".total").html("---"),$("input[name='data[risk_level]']").val(-1),$(".risk").html("---"),$(".risk").data("value",-1),$("input[name='data[gastronomy_score]']").val(""),$("#gastronome").html("---"))}function updateReportDate(t="undefined"){"undefined"==t&&(t=$("#datepicker").val()),n=t.split("-");var a=(t=3==n.length?new Date(2e3+parseInt(n[2])+"-"+n[1]+"-"+n[0]):new Date).getDate(),e=t.getMonth()+1;a<10&&(a="0"+a),e<10&&(e="0"+e);var n=a+"/"+e+"/"+t.getFullYear();$(".report-date").text(n)}function updateLangText(){$(".repeating").text(Lang.Repeating)}function updateReportRep(){$(".report-rep").text($(".employe li:last-child input").val())}function uploadFromSignsForms(){$(".subview-container").addClass("show"),$(".signs_forms .fileContent .item-check").prop("checked",!1)}function uploadCheckedFiles(){$(".subview-container").removeClass("show");var t=[];if($.each($("input.item-check:checked"),function(){t.push($(this).data("id"))}),0!=t.length){var a={_token:SF_TOKEN,ids:t};$.ajax({url:SF_UPLOAD_FILES_URL,dataType:"text",data:a,type:"post",success:function(t){$.each(JSON.parse(t),function(t,a){is_image=isImage(a),$("#malfunction-uploaded-documents").prepend('<div class="malfunction-uploads__item">'+`<a href="${BASE_URL}/uploads/${a}" target="_blank" class="malfunction-uploads__text">`+(is_image?'<img class="malfunction-principal__photo-item" src="'+BASE_URL+"/uploads/"+a+'" alt="'+a+'"/>':a.length>20?a.substr(0,20):a)+"</a>"+`<i class="malfunction-uploads__item-remove"></i>\n                        <input type="hidden" name="data[malfunction-uploads][]" value="${a}"/>\n                    </div>`)}),saveMalfunctionForm()}})}}function valid(){let t=!1;return"site"===$("#site").val()&&(t=!0),"subsite"===$("#subsite").val()&&$("#subsite option").length>=2&&(t=!0),-1===$("#service_level").val()&&(t=!0),$.each($(".malfunction-scoring__item"),function(a,e){const n=$(e),i=n.find(".malfunction-type-select").val(),o=n.find(".malfunction-finding-select").val();i&&("S"!==i&&"B"!==i||o.length)||(t=!0)}),!t}function updateButtonColor(){const t=document.getElementById("calculate");valid()?t.style.backgroundColor="#0074d9":t.style.backgroundColor=""}$(document).ready(function(){function t(t,a){var e=t.siblings(".malfunction-scoring__risk").find(".summernote-textarea"),n=$(t.siblings(".malfunction-scoring__finding").children()[0]),i=t.siblings(".malfunction-scoring__principal").find(".malfunction-scoring__principal-checkbox");a?n.multipleSelect("enable"):(n.multipleSelect("disable"),n.multipleSelect("setSelects",[]),n.removeClass("warn"),i.attr("disabled","true"),i.prop("checked",!1),$.each(e,function(t,a){$(a).summernote("disable"),$(a).addClass("disabled")}))}function a(t){$(t).summernote({toolbar:[["para",["ol","numListStyles","ul","bullListStyles","listStyles","paragraph"]],["style",["bold","underline","italic"]],["color",["color","color"]],["Misc",["undo","redo"]]],callbacks:{onChange:delay(function(t,a){var e=$(this).summernote("code");"admin"==user.title.toLowerCase()&&(-1==(e=getHtmlDiff(getOriginalHtml($(this).attr("uuid")),e)).indexOf("<span class='inserted'>")&&-1==e.indexOf("<span class='deleted'>")||$('input[name="data[status][admin_changed_date]"]').val("changed")),$(this).find("*").remove();for(var n=$(e).find("*"),i=0;i<n.length;i++){var o=n.eq(i);o[0].classList.contains&&o[0].classList.contains&&""==o.text().replace(/(\s|\r|\n)*/g,"")||$(this).append(o)}saveMalfunctionForm()},500),onInit:function(){$("button.note-btn.btn.btn-light.btn-sm.list-styles").removeClass("dropdown-toggle")}}})}$(function(){$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),window.prettyPrint&&prettyPrint(),$("#datepicker").datepicker({format:"dd-mm-yy",language:LOCALE}).on("changeDate",function(t){$("input[name='data[date]']").val(this.value),updateReportDate(this.value),saveMalfunctionForm()}),$("#time").datetimepicker({format:"HH:mm"}),$("input[name='data[service_level]']").val()||$("input[name='data[service_level]']").val($("#service_level").val()),today(),currentTime(),updateScoreLevels(),saveMalfunctionForm(),IS_SUBMITTED&&($(".malfunction-general.hidden, .malfunction-repaired.hidden, .malfunction-principal.hidden, .malfunction-list.hidden, .malfunction-summary.hidden, .malfunction-uploaded-documents.hidden").removeClass("hidden"),$(".malfunction-principal__item .summernote-textarea").length>0&&$("#malfunction-principal__items").sortable({handle:".malfunction-sort",update:saveMalfunctionForm}))}),$("#service_level").on("change",function(){$("input[name='data[service_level]']").val($(this).val()),saveMalfunctionForm()}),$("#company").on("change",function(){$("input[name='data[site]']").val(""),$("input[name='data[subsite]']").val(""),$("input[name='data[company_representative]']").val(""),$("#site").val("site"),$("#subsite").val("subsite");"company"==$(this).val()?($("#site").attr("disabled",!0),$("#subsite").attr("disabled",!0),$("input[name='data[company]']").val(""),saveMalfunctionForm()):($("input[name='data[company]']").val($("option:selected",this).text()),saveMalfunctionForm(),$.ajax({url:FILTER_COMPANY_URL,type:"post",data:{id:$(this).val()},success:function(t){$("#site").attr("disabled",!1),$("#subsite").attr("disabled",!0),$("#site").html(""),$("#site").prepend('<option value="site">Site</option>');for(var a=0;a<t.sites.length;a++)$("#site").append("<option value='"+t.sites[a].id+"'>"+t.sites[a].title+"</option>")}}))}),$("#site").on("change",function(){if($("input[name='data[subsite]']").val(""),"site"==$(this).val())$("#subsite").attr("disabled",!0),$("input[name='data[site]']").val(""),$("input[name='data[company_representative]']").val(""),saveMalfunctionForm(LOAD_STATISTICS_CHART);else{$("input[name='data[site]']").val($("option:selected",this).text());var t={id:$(this).val(),malfunction_id:MALFUNCTION_ID};$.ajax({url:FILTER_SITE_URL,type:"post",data:t,success:function(t){$("#subsite").attr("disabled",!1),$("#subsite").html(""),$("#subsite").prepend('<option  value="subsite">'+Lang["Sub-site"]+"</option>");for(var a=0;a<t.subsites.length;a++)$("#subsite").append("<option value='"+t.subsites[a].id+"'>"+t.subsites[a].title+"</option>");$("input[name='data[company_representative]']").val(t.repres[0]?t.repres[0].representative:""),lastMalfunctionType=JSON.parse(t.lastMalfunctionType),lastMalfunctionFinding=JSON.parse(t.lastMalfunctionFinding),saveMalfunctionForm(LOAD_STATISTICS_CHART)}})}}),$("#subsite").on("change",function(){$("input[name='data[subsite]']").val($("option:selected",this).text());var t={id:$(this).val(),site_id:$("#site").val(),malfunction_id:MALFUNCTION_ID};$.ajax({url:FILTER_SUBSITE_URL,type:"post",data:t,async:!1,success:function(t){t.repres&&$("input[name='data[company_representative]']").val(t.repres),lastMalfunctionType=JSON.parse(t.lastMalfunctionType),lastMalfunctionFinding=JSON.parse(t.lastMalfunctionFinding),saveMalfunctionForm(LOAD_STATISTICS_CHART)}})}),$(".malfunction-type-select").on("change",function(){"B"==this.value&&("severe"==$(this).closest("tr").data("type")&&($(".risk").text(Lang.High),$(".risk").data("value","High"),$("input[name='data[risk_level]']").val($(".risk").data("value")),saveMalfunctionForm()))}),$(document).on("click",".note-btn-group.btn-group.note-color .note-color:last-child .dropdown-menu .note-palette:first-child button.note-color-btn",function(){$('.note-btn-group.btn-group.note-color .note-color:first-child .dropdown-menu .note-palette:first-child button.note-color-btn[data-value="'+$(this).data("value")+'"').click()}),$.each($(".summernote-textarea").not(".disabled"),function(t,e){a(e)}),$(".malfunction-type-select").on("change",function(){"S"==this.value||"B"==this.value?t($(this).parent(),!0):t($(this).parent(),!1)}),$(".malfunction-finding-select").on("change",function(){$(this).attr("disabled",!1);var t=$(".malfunction-finding-select  li.selected").text(),e=$(this).val(),n=$(this).parent(),i=n.parent().data("id"),o=n.siblings(".malfunction-scoring__risk"),l=n.parent().data("category-id"),s=n.siblings(".malfunction-scoring__principal").find(".malfunction-scoring__principal-checkbox"),c=[],r=0;$.each(e,function(t,a){$("input[name='data[malfunction_principal]["+l+"]["+i+"]["+a+"]']").prop("disabled")&&(c[r]=a,r++)}),"B"==$(".malfunction-type-select option:selected").val()&&$.ajax({url:FIND_URL,type:"post",data:{find:t,paragraph_id:i},success:function(t){var a;$.each(c,function(e,n){a=$("input[name='data[malfunction_principal]["+l+"]["+i+"]["+n+"]']"),1==t.success?a.prop("checked",!0):a.prop("checked",!1)})}}),$.each($(".summernote-paragraph-"+i),function(t,e){a(e),$(e).summernote("disable"),$(e).addClass("disabled")}),$.each($(this).find("option"),function(t,a){a.selected?s[t].disabled=!1:s[t].disabled=!0});var d=$(this).prev().multipleSelect("getSelects");0==d.length?(o.addClass("hasnt_active"),n.siblings(".malfunction-scoring__principal").addClass("hasnt_active")):(o.removeClass("hasnt_active"),n.siblings(".malfunction-scoring__principal").removeClass("hasnt_active")),"object"==typeof d&&d.length>0&&d.forEach(function(t,a){o.find("#summernote-paragraph-"+i+"-"+t).summernote("enable"),o.find("#summernote-paragraph-"+i+"-"+t).removeClass("disabled")}),saveMalfunctionForm()}),$(document).on("click",".malfunction-principal__photo-remove, .malfunction-uploads__item-remove",function(){$(this).parent().remove(),saveMalfunctionForm()}),$("body").on("change",".malfunction-upload-image",function(){var t=this,a=$(this).prop("files")[0],e=new FormData;e.append("file",a),$(this).closest(".malfunction-scoring__photos").prepend("<div class='malfunction-principal__photo-item'><span class='uploadProgressBar'></span></div>"),$.ajax({url:UPLOAD_FILE_URL,dataType:"text",cache:!1,contentType:!1,processData:!1,data:e,type:"post",success:function(a){var e=isImage(a),n=BASE_URL+(e?"/images/":"/uploads/"),i=$(t).closest(".malfunction-principal__item").data("category-id"),o=$(t).closest(".malfunction-principal__item").data("id");$(t).closest(".malfunction-scoring__photos").prepend('<div class="malfunction-principal__photo-item"><a href="'+n+a+'" target="_blank">'+(e?'<img src="'+n+a+'" class="malfunction-principal__photo-item" alt="'+a+'"/>':a.length>20?a.substr(0,20):a)+'</a><i class="malfunction-principal__photo-remove"></i><input type="hidden" name="data[photo]['+i+"]["+o+'][]" value="'+a+'"/></div>'),saveMalfunctionForm()},xhr:function(){var t=new window.XMLHttpRequest;return t.upload.addEventListener("progress",uploadProgressHandler,!1),t.addEventListener("load",loadHandler,!1),t}})});var e={F:1,S:.5,B:0,N:1,C:1};$("#calculate").on("click",function(t){t.preventDefault();var a=!1,n={},i="",o=[],l=[];if($(".warn").removeClass("warn"),"site"==$("#site").val()&&(a=!0,$("#site").addClass("warn")),"subsite"==$("#subsite").val()&&$("#subsite option").length>=2&&(a=!0,$("#subsite").addClass("warn")),-1==$("#service_level").val()&&(a=!0,$("#service_level").addClass("warn")),$.each($(".malfunction-scoring__item"),function(t,s){var c=$(s),r=c.find(".malfunction-scoring__paragraph-number").html(),d=c.find(".malfunction-scoring__paragraph-name").html(),u=c.find(".malfunction-type-select").val(),p=c.find(".malfunction-finding-select").html(),m=(c.find(".summernote-textarea").val(),c.find(".malfunction-scoring__principal-checkbox")),f=c.data("category-id"),g=c.data("id"),h=(c.data("frr"),""),v=$('.malfunction-principal__item[data-category-id="'+f+'"][data-id="'+g+'"]').find(".malfunction-principal__photo-item").clone(!0);$.each(v,function(t,a){h+=$(a).get(0).outerHTML,console.log(d)}),u?"S"!=u&&"B"!=u||p.length||(c.find(".malfunction-finding-select").addClass("warn"),a=!0):(c.find(".malfunction-type-select").addClass("warn"),a=!0);var _=e[u]*c.data("value");c.find(".malfunction-scoring__score").html((_?_.toFixed(1):0)+"%"),$("#calc-input-paragraph-"+f+"-"+g).val(_.toFixed(1)+"%"),l[t]={score:c.data("value"),html:""};var y="",b="",x="";$.each(c.find(".summernote-textarea"),function(t,a){if(!$(a).hasClass("disabled")){var e=$(a).val().trim();e="X "+(e=(e=(e=(e=(e=e.replace(/(<p><\/p>|<ol><\/ol>|<ul><\/ul>)*/g,"")).replace(/<p><br><\/p>/g,"")).replace(/<p/g,"<span")).replace(/<\/p>/g,"</span>")).replace(/></g,">, <")).trim(" ,"),b+="<div>"+e+"</div>",y+="<a>"+d+" ("+r+"):</a>"+$(a).val()}}),o.push("#principal-textarea-"+f+"-"+g+"-"+t),-1!==$.inArray(u,["S","B"])&&void 0!==lastMalfunctionType[f]&&lastMalfunctionType[f]&&-1!==$.inArray(lastMalfunctionType[f][g],["S","B"])&&(x=" <strong class='repeating'></strong>");let S=!1;if($.each(c.find(".malfunction-scoring__principal-checkbox"),function(t,a){a.checked&&(S=!0)}),b&&S&&(l[t].html='<div class="malfunction-principal__item" data-category-id="'+f+'" data-id="'+g+'">\n                    <div class="malfunction-sort"></div>\n                    <textarea onchange="saveMalfunctionForm()" class="summernote-textarea"  name="data[malfunction_principal_detail]['+t+'][value]" id="principal-textarea-'+f+"-"+g+`-${t}">\n                        <p>`+d+x+"</p>\n                        "+b+'\n                    </textarea>\n                    <input type="hidden" name="data[malfunction_principal_detail]['+t+'][category_id]" value="'+f+'" />\n                    <input type="hidden" name="data[malfunction_principal_detail]['+t+'][id]" value="'+g+'" />\n                    <div class="malfunction-scoring__photos '+(-1===$.inArray(u,["S","B"])?"disabled":"")+'">\n                        '+h+'\n                         <div class=\'upload-photo-wrapper\'>\n                                <label class="malfunction-scoring__add-photo" for="add-image-` + category_id + `-` + paragraph_id + `">\n                                <i class="fa fa-upload"></i>\n                                <input id="add-image-` + category_id + `-` + paragraph_id + `" class="malfunction-upload-image" type="file" ` + ($.inArray(type, ["S", "B"]) === -1 ? "disabled" : "") + `>                                                        </label>\n                         </div>\n                  \n                    </div>\n                </div>'),$(c.find(".malfunction-finding-select")[0]).next().children("button.ms-choice").hasClass("disabled"))n[c.data("category-id")]?n[c.data("category-id")].score+=_:n[c.data("category-id")]={score:_,malfunctions:[]};else{n[c.data("category-id")]?(n[c.data("category-id")].score+=_,n[c.data("category-id")].malfunctions.push(y),n[c.data("category-id")].name=c.data("category-name"),n[c.data("category-id")].in_list=!0):n[c.data("category-id")]={score:_,malfunctions:[y],name:c.data("category-name"),in_list:!0};var k=0;$.each(c.find(".summernote-textarea"),function(t,a){$(a).hasClass("disabled")||$.each($($.parseHTML($(a).val())),function(a,e){"object"==typeof e.classList&&e.classList.contains("frr_repair")&&m[t].checked&&(i+="<p>4."+ ++k+" "+e.innerHTML+"</p>")})})}}),l.sort(function(t,a){return t.score<a.score?1:t.score>a.score?-1:0}),a)$("#malfunction-calc-error-msg").html(Lang.SomeFieldsAreMissiing);else{$("#malfunction-principal__items").html("");var s="";$.each(l,function(t,a){a.html&&(s+=a.html)}),$("#malfunction-principal__items").html($("#malfunction-principal__items").html()+s),$(".malfunction-general.hidden, .malfunction-repaired.hidden, .malfunction-principal.hidden, .malfunction-list.hidden, .malfunction-summary.hidden, .malfunction-uploaded-documents.hidden").removeClass("hidden");var c="",r=0,d=1,u=1;for(category_id in n){var p=n[category_id].score;if($("#category-score-"+category_id).html(p.toFixed(1)+"%"),category_id!=$(".fork-number").attr("fork")&&(r+=p),$("#calc-input-category-"+category_id).val(p.toFixed(1)+"%"),n[category_id].in_list){c+="<p><b><u>"+u+". "+n[category_id].name+" ("+d+"):</u></b></p>";var m=1;n[category_id].malfunctions.forEach(function(t){var a=u+"."+m+". ",e=t.replace("<a>","<a>"+a);c+=e,m++}),c+="<p><br></p>",u++}d++}var f="<p>2.1 "+Lang.Inspection_made+"</p><p>2.2 "+Lang.Inspection_done+"</p><p>2.3 "+Lang.TwoPointThreeValue+"</p>",g="";$.each($("select.malfunction-type-select"),function(t,a){var e=$(a).val(),n=$(a).closest("tr").find("select.malfunction-finding-select"),i=n.attr("name").replace("data[malfunction_finding][","");i=i.split("]")[0];var o=n.attr("name").replace("data[malfunction_finding]["+i+"][","");o=o.split("]")[0],"F"!==e||void 0===lastMalfunctionType[i]||void 0===lastMalfunctionType[i][o]||"S"!==lastMalfunctionType[i][o]&&"B"!==lastMalfunctionType[i][o]||$.each(categories,function(t,a){a.id==i&&$.each(a.paragraphs,function(t,a){a.id==o&&$.each(a.frr,function(t,a){void 0!==lastMalfunctionFinding[i]&&void 0!==lastMalfunctionFinding[i][o]&&-1!=lastMalfunctionFinding[i][o].indexOf(a.id.toString())&&(g+="<p>&#x2714; "+a.finding+"</p>")})})})}),$("#malfunction-general-textarea").summernote("code",f),$("#malfunction-repaired-textarea").summernote("code",g),$("#malfunction-list-textarea").summernote("code",c),$("#malfunction-summary-textarea").summernote("code",i),$(".malfunction-scoring__total-info span").html(r.toFixed(1)+"%"),$(".total").html(r.toFixed(1)+"%");for(var h=r>=85&&r<=100,v=r>=75&&r<=84,_=r<75,y=[],b=0;b<$(".malfunction-type-select").length;b++)y.push($(".malfunction-type-select").eq(b).val());-1==y.indexOf("B")?h?($(".risk").text(Lang.Low),$(".risk").data("value","Low")):v?($(".risk").text(Lang.Medium),$(".risk").data("value","Medium")):_&&($(".risk").text(Lang.High),$(".risk").data("value","High")):($(".risk").text(Lang.High),$(".risk").data("value","High")),$("input[name='data[risk_level]']").val($(".risk").data("value")),$("#malfunction-principal__items").sortable({handle:".malfunction-sort",update:saveMalfunctionForm}),$("#calc-input-total").val(r.toFixed(1)+"%"),o.forEach(function(t,a){$(t).summernote({toolbar:[["para",["ol","numListStyles","ul","bullListStyles","listStyles","paragraph"]],["style",["bold","underline","italic"]],["color",["color","color"]],["Misc",["undo","redo"]]],callbacks:{onChange:delay(function(t,a){var e=$(this).summernote("code");"admin"==user.title.toLowerCase()&&(-1==(e=getHtmlDiff(getOriginalHtml($(this).attr("uuid")),e)).indexOf("<span class='inserted'>")&&-1==e.indexOf("<span class='deleted'>")||$('input[name="data[status][admin_changed_date]"]').val("changed")),$(this).find("*").remove();for(var n=$(e).find("*"),i=0;i<n.length;i++){var o=n.eq(i);o[0].classList.contains&&o[0].classList.contains&&""==o.text().replace(/(\s|\r|\n)*/g,"")||$(this).append(o)}saveMalfunctionForm()},500),onInit:function(){$("button.note-btn.btn.btn-light.btn-sm.list-styles").removeClass("dropdown-toggle")}}})});var x=0,S=$(".malfunction-scoring__table[data-category-id="+FORK+"] .malfunction-type-select");$.each(S,function(t,a){switch($(a).val()){case"S":x+=50;break;case"B":x+=0;break;default:x+=100}});var k=x/(void 0!==S&&0!=S.length?S.length:1);k=k.toFixed(2),$("#gastronome").html(k+"%"),$("input[name='data[gastronomy_score]']").val($("#gastronome").text()),$("#malfunction-calc-error-msg").html(""),calculating=!1,saveMalfunctionForm(LOAD_STATISTICS_CHART)}updateLangText(),updateReportRep(),updateReportDate(),updateOriginalData(),updateSendToAdminButton();var T=MALFUNCTION_ID,L=$(".risk").val();$.ajax({url:LEVEL_URL,type:"post",data:{id:T,level:L},success:function(){}})}),$(".malfunction-type-select, .malfunction-scoring__principal-checkbox, .contractor_representative").on("change",function(){saveMalfunctionForm()}),$(document).on("change",".warn",function(){$(this).removeClass("warn")}),$("#malfunction-culinary-check").click(function(){$(".malfunction-culinary-heading").toggleClass("hidden"),$("#malfunction-culinary-textarea").toggleClass("summernote-textarea").toggleClass("hidden"),$("#malfunction-culinary-textarea").hasClass("summernote-textarea")?($("#malfunction-culinary-textarea").summernote({toolbar:[["para",["ol","numListStyles","ul","bullListStyles","listStyles","paragraph"]],["style",["bold","underline","italic"]],["color",["color","color"]],["Misc",["undo","redo"]]],callbacks:{onChange:delay(function(t,a){var e=$(this).summernote("code");"admin"==user.title.toLowerCase()&&(-1==(e=getHtmlDiff(getOriginalHtml($(this).attr("uuid")),e)).indexOf("<span class='inserted'>")&&-1==e.indexOf("<span class='deleted'>")||$('input[name="data[status][admin_changed_date]"]').val("changed")),$(this).find("*").remove();for(var n=$(e).find("*"),i=0;i<n.length;i++){var o=n.eq(i);o[0].classList.contains&&o[0].classList.contains&&""==o.text().replace(/(\s|\r|\n)*/g,"")||$(this).append(o)}saveMalfunctionForm()},500),onInit:function(){$("button.note-btn.btn.btn-light.btn-sm.list-styles").removeClass("dropdown-toggle")}}}),updateOriginalData(),$("#malfunction-culinary-textarea").next(".note-editor.note-frame.card").removeClass("hidden")):$("#malfunction-culinary-textarea").next(".note-editor.note-frame.card").addClass("hidden"),saveMalfunctionForm()}),(chart=new CanvasJS.Chart("chartContainer",{theme:"light2",animationEnabled:!0,axisX:{title:Lang.Date,interval:1,intervalType:"week",labelAngle:-50,labelFontSize:16,valueFormatString:"YYYY-MM-DD",reversed:!0},axisY2:{title:Lang.Score,labelFontSize:16,valueFormatString:"#0"},data:[{type:"line",markerSize:12,xValueFormatString:"YYYY-MM-DD",yValueFormatString:"###.#",dataPoints:[]}]})).render(),clearTrialMark($(".canvasjs-chart-canvas")[0],"#fff",chart.height),$("#duplicate_malfunction").click(function(){var t={_token:TOKEN,malfunction_id:MALFUNCTION_ID};$.ajax({url:DUPLICATE_MALFUCNTION_URL,type:"POST",dataType:"json",data:t,success:function(t){location.href=BASE_URL+"/malfunctions/"+t.malfunction_id+"/edit"}})}),$("#download_pdf").click(function(){$("#app nav").css("display","none"),$(".malfunction-other").css("display","none");for(var t=$(document).width(),a=$(document).height(),e=1;e<=10;e++)if(a*e>t){a*=e;break}html2pdf(document.documentElement,{margin:1,filename:"ציונים.pdf",image:{type:"jpeg",quality:.98},html2canvas:{dpi:192,letterRendering:!0},jsPDF:{unit:"pt",format:[t,a],orientation:"portrait"},callback:function(t,a){t.save(a),$("#app nav").css("display","none"),$(".malfunction-scoring").css("display","none");for(var e=$(document).outerWidth(),n=$(document).outerHeight(),i=1;i<=10;i++)if(n*i>e){n*=i;break}html2pdf(document.documentElement,{margin:1,filename:"מבדק.pdf",image:{type:"jpeg",quality:.98},html2canvas:{dpi:192,letterRendering:!0},jsPDF:{unit:"pt",format:[e,n],orientation:"portrait"}}),$(".malfunction-scoring").css("display","block"),$("#app nav").css("display","flex")}}),$(".malfunction-other").css("display","block"),$("#app nav").css("display","flex")}),$("#share_pdf").click(function(){$(".modal.sharing").addClass("show")}),$("#print_pdf").click(function(){if(window_focus){$("#printingScorinig").remove(),$("#printing-holder").append("<div id='printingScorinig' style='background-color: white; padding: 20px;'></div>"),$(".malfunction-scoring").clone().appendTo("#printingScorinig");var t=document.getElementById("printingScorinig").innerHTML,a=window.open("",Lang.Print,"width=1200, height=600");a.document.innerHTML="",a.document.write('<html><head><title>Print</title><link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.9/summernote-bs4.css" rel="stylesheet" media="all"><link rel="stylesheet" href="'+BASE_URL+'/css/multiselect.css" media="all"><link rel="stylesheet" href="'+BASE_URL+'/css/app.css" media="all"><link rel="stylesheet" href="'+BASE_URL+'/css/custom.css" rel="stylesheet" media="all"><link rel="stylesheet" href="'+BASE_URL+'/css/malfunctions/main.css" media="all"><link rel="stylesheet" href="'+BASE_URL+'/css/malfunctions/edit.css" media="all"><link rel="stylesheet" href="'+BASE_URL+'/css/malfunctions/print.css" media="all">'+("he"==LOCALE?'<link rel="stylesheet"href="'+BASE_URL+'/css/malfunctions/main_rtl.css" media="all">':"")+'</head><body ><div class="container"><div class="row justify-content-center"><div class="col-md-12 card malfunctions"><form id="malfunction-form">'),a.document.write(t);var e=a.document.getElementsByClassName("canvasjs-chart-canvas")[0].getContext("2d"),n=$(".malfunction-scoring .canvasjs-chart-canvas")[0];e.drawImage(n,0,0),a.document.write("</form></div></div></div></body></html>"),a.document.close(),a.focus(),setTimeout(()=>{a.print(),a.close(),$("#printingScorinig").remove()},500)}}),$("#send_to_admin").click(function(){$("#send_to_admin").hasClass("disabled")||swal({title:Lang["Are you sure?(send to admin)"],type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:Lang.Yes,cancelButtonText:Lang["Cancel(no)"]}).then(t=>{t.value&&($(".loader-container").css("display","block"),$("#loadingBlock").fadeIn(100),$("input[name='data[status][stage]']").val("pending"),calculating=!1,saveMalfunctionForm(REDIRECT_TO_FORMLIST_PAGE))})}),reloadStatistics(),updateLangText(),updateReportRep(),updateReportDate(),updateOriginalData(),updateSendToAdminButton()}),$(".subview-container").on("click",function(){$(".subview-container").removeClass("show")}),$(".subview-container").on("keyup",function(t){27==t.keycode&&$(".subview-container").removeClass("show")}),$(".signs_forms").on("click",function(t){t.stopPropagation()}),$(".modal").on("click",function(t){t.stopPropagation()}),$("#upload_from_computer").click(function(t){$("#file").click()});